{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}
{% block content %}
<h1 class="mb-4">Manage Users</h1>

<div class="mb-4">
    <a href="{{ url_for('admin.add_doctor') }}" class="btn btn-success"><i class="fas fa-plus-circle"></i> Add New Doctor</a>
</div>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>ID</th>
                <th>Full Name</th>
                <th>Email</th>
                <th>Role</th>
                <th>Active</th>
                <th>2FA Enabled</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.full_name | e }}</td>
                <td>{{ user.email | e }}</td>
                <td>{{ user.role | capitalize }}</td>
                <td>
                    <span class="badge badge-{% if user.is_active %}success{% else %}danger{% endif %}">
                        {{ 'Active' if user.is_active else 'Inactive' }}
                    </span>
                </td>
                <td>
                    <span class="badge badge-{% if user.google_authenticator_secret %}success{% else %}secondary{% endif %}">
                        {{ 'Yes' if user.google_authenticator_secret else 'No' }}
                    </span>
                </td>
                <td>
                    <form method="POST" action="{{ url_for('admin.manage_users') }}" class="d-inline-block">
                        <input type="hidden" name="user_id" value="{{ user.id }}">
                        
                        {% if user.id != current_user.id %} {# Prevent admin from toggling their own active status #}
                        <button type="submit" name="action" value="toggle_active" 
                                class="btn btn-{% if user.is_active %}warning{% else %}success{% endif %} btn-sm mr-2"
                                onclick="return confirm('Are you sure you want to {{ 'deactivate' if user.is_active else 'activate' }} user {{ user.email | e }}?');">
                            {{ 'Deactivate' if user.is_active else 'Activate' }}
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-secondary btn-sm mr-2" disabled title="Cannot deactivate your own account">Self</button>
                        {% endif %}

                        <div class="input-group d-inline-flex mr-2" style="width: auto;">
                            <select name="new_role" class="custom-select custom-select-sm" required>
                                <option value="" disabled selected>Change Role</option>
                                <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>Admin</option>
                                <option value="doctor" {% if user.role == 'doctor' %}selected{% endif %}>Doctor</option>
                                <option value="patient" {% if user.role == 'patient' %}selected{% endif %}>Patient</option>
                            </select>
                            <div class="input-group-append">
                                {% if user.id != current_user.id %} {# Prevent admin from changing their own role #}
                                <button type="submit" name="action" value="change_role" class="btn btn-info btn-sm"
                                        onclick="return confirm('Are you sure you want to change role for {{ user.email | e }}? This may affect their profile.');">
                                    Apply
                                </button>
                                {% else %}
                                <button type="button" class="btn btn-secondary btn-sm" disabled title="Cannot change your own role">Apply</button>
                                {% endif %}
                            </div>
                        </div>

                        {% if user.id != current_user.id %} {# Prevent admin from deleting their own account #}
                        <button type="submit" name="action" value="delete" class="btn btn-danger btn-sm"
                                onclick="return confirm('WARNING: Are you sure you want to permanently delete user {{ user.email | e }}? This action cannot be undone.');">
                            Delete
                        </button>
                        {% else %}
                        <button type="button" class="btn btn-secondary btn-sm" disabled title="Cannot delete your own account">Delete</button>
                        {% endif %}
                    </form>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7">No users found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}